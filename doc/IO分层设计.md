# 文件系统分层设计

## 支持的系统调用

### fsync
- 同步文件所有的脏页回硬盘

### fclose
- 关闭文件描述符
- 清理vma映射
- 写回文件

### open
- 打开的是inode的硬盘版本

### 目前没打算支持的系统调用
- msync 直接转发给fsync
- madvise
- mincore
- fincore

## 块设备IO分层设计

### 设备节点
- 维护page和活跃buffer的对应关系
- 转发IO任务给设备驱动
- 管理文件预读与预写
- 在写回时维护vm和pm的脏页状态

### 底层文件系统
- 转发任务给设备节点

### addrspace页缓存对象
- 直接和页池互动
- 发起文件IO的起点


### 文件inode
- 需要同时维护inode在硬盘上的版本，和缓存中的版本。
- 管理文件元数据
- 维护文件偏移量->块号的对应关系
- 维护文件偏移量->物理页的对应关系

### file
- 文件读写的中心
- 持有inode的引用
- 持有addrspace的引用
- 转发任务给文件系统

### vma
- 持有file

### mm
- 维护文件虚拟地址映射->文件偏移量的对应关系
- 通过页错误维护vm和pm的脏页状态